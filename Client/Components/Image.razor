@implements IDisposable
@using OpenCvSharp;
@using SpawnDev.BlazorJS.JSObjects;
<canvas @onclick="SelectImage" title="@CurrentData"
        id="@CurrentData"
        style="zoom: @(Zoom)%; border:@(_selected? "3px solid blue":"1px solid grey");"></canvas>

@code {
    [Inject] IImageDataHandler ImageDataHandler { get; set; } = default!;
    [Inject] IJSRuntime JS { get; set; } = default!;
    [Parameter] public Guid CurrentData { get; set; }
    [Parameter] public int Zoom { get; set; } = 100;
    private bool _selected;

    public void SelectImage()
    {
        ImageDataHandler.SelectImage(CurrentData);
    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;
        ImageDataHandler.ImageSelected += OnImageSelected;
        ImageDataHandler.ReRenderImage += OnReRenderImage;
        ImageDataHandler.ImageRemoved += OnImageRemoved;
        var data = ImageDataHandler.GetRenderData(CurrentData);
        if (data.PreviousImage == null) await RenderImage(data.OriginalImage);
        else await RenderPipelineImage(data);
        await base.OnAfterRenderAsync(firstRender);
    }
    public async Task OnReRenderImage(Guid guid)
    {
        if (CurrentData != guid) return;
        var data = ImageDataHandler.GetRenderData(CurrentData);
        await RenderPipelineImage(data);
        StateHasChanged();
    }
    public Task OnImageRemoved(Guid guid)
    {
        if (CurrentData != guid) return Task.CompletedTask;
        Dispose();
        return Task.CompletedTask;
    }
    public Task OnImageSelected(Guid guid)
    {
        if (CurrentData != guid) _selected = false;
        else _selected = true;
        StateHasChanged();
        return Task.CompletedTask;
    }
    public async Task RenderImage(string image)
    {
        await JS.ExecuteModuleFunction("DrawSourceImage", new List<object> { CurrentData, image });
        await InvokePictureRendered();
    }
    public async Task RenderPipelineImage(MatImageData pipelineAction)
    {
    }
    public async Task InvokePictureRendered()
    {
        await ImageDataHandler.ImageRendered(new MatImageData()
            {
                Guid = CurrentData,
            });
    }
    public void Dispose()
    {
        _selected = false;
        ImageDataHandler.ImageSelected -= OnImageSelected;
        ImageDataHandler.ReRenderImage -= OnReRenderImage;
        ImageDataHandler.ImageRemoved -= OnImageRemoved;
    }
}
